# syntax=docker/dockerfile:1
# FiGS Docker Environment
# Based on official nerfstudio Dockerfile with FiGS-specific modifications
#
# Key differences from official nerfstudio:
#   - numpy pinned to 1.26.4 (not just <2.0)
#   - gsplat version configurable (default 1.5.3 for nbv-splat compatibility)
#   - acados included for MPC-based control
#   - gemsplat dependencies pre-installed
#
# IMPORTANT: gemsplat/rasterization_routines/rendering.py requires updates for gsplat 1.5.3:
#   - fully_fused_projection returns 8 values (adds batch_ids as first element)
#   - isect_tiles uses n_images/image_ids instead of n_cameras/camera_ids

ARG UBUNTU_VERSION=22.04
ARG NVIDIA_CUDA_VERSION=11.8.0
ARG CUDA_ARCHITECTURES="90;89;86;80;75;70;61"
ARG GSPLAT_VERSION=1.5.3
ARG NERFSTUDIO_VERSION=""

# === SOURCE STAGE ===
# Pull nerfstudio source either from local copy or git
FROM scratch as source_copy
ONBUILD COPY . /tmp/nerfstudio
FROM alpine/git as source_no_copy
ARG NERFSTUDIO_VERSION
ONBUILD RUN git clone --branch ${NERFSTUDIO_VERSION} --recursive https://github.com/nerfstudio-project/nerfstudio.git /tmp/nerfstudio
ARG NERFSTUDIO_VERSION
FROM source_${NERFSTUDIO_VERSION:+no_}copy as source

# === BUILDER STAGE ===
FROM nvidia/cuda:${NVIDIA_CUDA_VERSION}-devel-ubuntu${UBUNTU_VERSION} as builder
ARG CUDA_ARCHITECTURES
ARG NVIDIA_CUDA_VERSION
ARG UBUNTU_VERSION
ARG GSPLAT_VERSION

ENV DEBIAN_FRONTEND=noninteractive
ENV QT_XCB_GL_INTEGRATION=xcb_egl

# System dependencies (same as official nerfstudio + acados deps)
RUN apt-get update && \
    apt-get install -y --no-install-recommends --no-install-suggests \
        git \
        wget \
        ninja-build \
        build-essential \
        libboost-program-options-dev \
        libboost-filesystem-dev \
        libboost-graph-dev \
        libboost-system-dev \
        libeigen3-dev \
        libflann-dev \
        libfreeimage-dev \
        libmetis-dev \
        libgoogle-glog-dev \
        libgtest-dev \
        libsqlite3-dev \
        libglew-dev \
        qtbase5-dev \
        libqt5opengl5-dev \
        libcgal-dev \
        libceres-dev \
        python3.10-dev \
        python3-pip \
        cmake \
        liblapack-dev \
        libblas-dev \
        && rm -rf /var/lib/apt/lists/*

# CMake (same as official)
RUN wget https://github.com/Kitware/CMake/releases/download/v3.31.3/cmake-3.31.3-linux-x86_64.sh \
    -q -O /tmp/cmake-install.sh \
    && chmod u+x /tmp/cmake-install.sh \
    && mkdir /opt/cmake-3.31.3 \
    && /tmp/cmake-install.sh --skip-license --prefix=/opt/cmake-3.31.3 \
    && rm /tmp/cmake-install.sh \
    && ln -s /opt/cmake-3.31.3/bin/* /usr/local/bin

# GLOMAP (same as official)
RUN git clone https://github.com/colmap/glomap.git && \
    cd glomap && \
    git checkout "1.0.0" && \
    mkdir build && \
    cd build && \
    mkdir -p /build && \
    cmake .. -GNinja "-DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHITECTURES}" \
        -DCMAKE_INSTALL_PREFIX=/build/glomap && \
    ninja install -j1 && \
    cd ~ && rm -rf /glomap

# COLMAP (same as official)
RUN git clone https://github.com/colmap/colmap.git && \
    cd colmap && \
    git checkout "3.9.1" && \
    mkdir build && \
    cd build && \
    mkdir -p /build && \
    cmake .. -GNinja "-DCMAKE_CUDA_ARCHITECTURES=${CUDA_ARCHITECTURES}" \
        -DCMAKE_INSTALL_PREFIX=/build/colmap && \
    ninja install -j1 && \
    cd ~ && rm -rf /colmap

# Python dependencies - MODIFIED: pin numpy==1.26.4
RUN pip install --no-cache-dir --upgrade pip 'setuptools<70.0.0' && \
    pip install --no-cache-dir \
        torch==2.1.2+cu118 \
        torchvision==0.16.2+cu118 \
        numpy==1.26.4 \
        --extra-index-url https://download.pytorch.org/whl/cu118

# Hierarchical-Localization (same as official)
RUN git clone --branch master --recursive https://github.com/cvg/Hierarchical-Localization.git /opt/hloc && \
    cd /opt/hloc && git checkout v1.4 && \
    python3.10 -m pip install --no-cache-dir . && \
    cd ~ && rm -rf /opt/hloc/.git

# tiny-cuda-nn (same as official)
RUN TCNN_CUDA_ARCHITECTURES="${CUDA_ARCHITECTURES}" \
    pip install --no-cache-dir \
    "git+https://github.com/NVlabs/tiny-cuda-nn.git@b3473c81396fe927293bdfd5a6be32df8769927c#subdirectory=bindings/torch"

# Additional Python deps (same as official)
RUN pip install --no-cache-dir pycolmap==0.6.1 pyceres==2.1 omegaconf==2.3.0

# gsplat - MODIFIED: use configurable version (default 1.5.3 for nbv-splat compatibility)
RUN export TORCH_CUDA_ARCH_LIST="$(echo "$CUDA_ARCHITECTURES" | tr ';' '\n' | awk '$0 > 70 {print substr($0,1,1)"."substr($0,2)}' | tr '\n' ' ' | sed 's/ $//')" && \
    export MAX_JOBS=4 && \
    pip install --no-cache-dir gsplat==${GSPLAT_VERSION} --index-url https://docs.gsplat.studio/whl/pt21cu118

# nerfstudio from source
COPY --from=source /tmp/nerfstudio/ /tmp/nerfstudio
RUN pip install --no-cache-dir /tmp/nerfstudio numpy==1.26.4 && \
    rm -rf /tmp/nerfstudio

# === FiGS-SPECIFIC DEPENDENCIES ===

# FiGS misc dependencies (from install-serverside.sh lines 140-149)
RUN pip install --no-cache-dir \
    albumentations \
    qpsolvers \
    tabulate \
    cython \
    ipykernel \
    ipympl \
    rich \
    "imageio[ffmpeg]" \
    roma

# gemsplat dependencies (from gemsplat/pyproject.toml)
# Pre-install these so container startup is fast
RUN pip install --no-cache-dir \
    timm \
    ftfy \
    regex \
    tqdm \
    einops \
    gdown \
    matplotlib \
    pillow

# torchtyping with --no-deps to avoid typeguard conflict with nerfstudio's tyro
RUN pip install --no-cache-dir --no-deps torchtyping

# CLIP from OpenAI (required by gemsplat)
RUN pip install --no-cache-dir git+https://github.com/openai/CLIP.git

# === ACADOS BUILD ===
# Build acados for MPC-based trajectory control
RUN git clone https://github.com/acados/acados.git /opt/acados && \
    cd /opt/acados && \
    git submodule update --init --recursive && \
    mkdir -p build && \
    cd build && \
    cmake -DACADOS_WITH_QPOASES=ON -DCMAKE_INSTALL_PREFIX=/opt/acados .. && \
    make install -j4 && \
    pip install --no-cache-dir -e /opt/acados/interfaces/acados_template

# Set acados environment variables
ENV ACADOS_SOURCE_DIR=/opt/acados
ENV LD_LIBRARY_PATH=/opt/acados/lib:${LD_LIBRARY_PATH}

# Fix permissions
RUN chmod -R go=u /usr/local/lib/python3.10 && \
    chmod -R go=u /build

# === RUNTIME STAGE ===
FROM nvidia/cuda:${NVIDIA_CUDA_VERSION}-runtime-ubuntu${UBUNTU_VERSION} as runtime
ARG CUDA_ARCHITECTURES
ARG NVIDIA_CUDA_VERSION
ARG UBUNTU_VERSION
ARG GSPLAT_VERSION

LABEL org.opencontainers.image.description="FiGS environment with nerfstudio, gsplat ${GSPLAT_VERSION}, and acados"
LABEL org.opencontainers.image.source="https://github.com/StanfordMSL/FiGS-Standalone"

RUN apt-get update && \
    apt-get install -y --no-install-recommends --no-install-suggests \
        libboost-filesystem1.74.0 \
        libboost-program-options1.74.0 \
        libc6 \
        libceres2 \
        libfreeimage3 \
        libgcc-s1 \
        libgl1 \
        libglew2.2 \
        libgoogle-glog0v5 \
        libqt5core5a \
        libqt5gui5 \
        libqt5widgets5 \
        python3.10 \
        python3.10-dev \
        build-essential \
        python-is-python3 \
        ffmpeg \
        git \
        liblapack3 \
        libblas3 \
        && rm -rf /var/lib/apt/lists/*

# Copy build artifacts
COPY --from=builder /build/colmap/ /usr/local/
COPY --from=builder /build/glomap/ /usr/local/
COPY --from=builder /usr/local/lib/python3.10/dist-packages/ /usr/local/lib/python3.10/dist-packages/
COPY --from=builder /usr/local/bin/ns* /usr/local/bin/
COPY --from=builder /opt/acados/ /opt/acados/

# Set acados environment variables in runtime
ENV ACADOS_SOURCE_DIR=/opt/acados
ENV LD_LIBRARY_PATH=/opt/acados/lib:${LD_LIBRARY_PATH}

# Install nerfstudio CLI
RUN /bin/bash -c 'ns-install-cli --mode install'

WORKDIR /workspace

# Container startup script
RUN echo '#!/bin/bash\n\
echo "FiGS Docker Environment"\n\
echo "========================"\n\
echo "gsplat version: $(python -c \"import gsplat; print(gsplat.__version__)\" 2>/dev/null || echo \"unknown\")"\n\
echo "numpy version: $(python -c \"import numpy; print(numpy.__version__)\")"\n\
echo "torch version: $(python -c \"import torch; print(torch.__version__)\")"\n\
echo ""\n\
echo "To install FiGS (first time only):"\n\
echo "  cd /workspace/FiGS-Standalone && pip install -e . --no-deps"\n\
echo "  cd /workspace/FiGS-Standalone/gemsplat && pip install -e . --no-deps"\n\
echo "  ns-install-cli"\n\
echo ""\n\
echo "To install coverage_view_selection (nbv-splat):"\n\
echo "  cd /workspace/coverage_view_selection && pip install -e ."\n\
echo "  ns-install-cli"\n\
echo ""\n\
exec "$@"' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash", "-l"]
